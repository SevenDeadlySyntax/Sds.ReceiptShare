@model Sds.ReceiptShare.Ui.Web.Models.Group.AddMembersViewModel
@{
    ViewData["Title"] = "Add members to the group";
}

<h2>Add Members</h2>
<hr />
<div class="row" onload="loadMembers()">
    <div class="col-md-4">
        <div class="form-group">
            <label for="AddEmail">Add member</label>
            <input id="AddEmail" type="email" placeholder="Email address" class="input-sm" inputmode="email" />
            <input type="button" value="Add" class="btn-link" onclick="addMember()" />
            <label id="AddEmailValidator" class="alert-danger" style="display:none;">Please enter a valid email address for a member not already listed.</label>
        </div>

        <div class="form-group">
            <div id="Members" class="btn-group-vertical">Loading members...</div>
        </div>

        <div class="form-group">
            <form asp-action="AddMembers">
                @Html.HiddenFor(model => model.EmailAddresses)
                <div asp-validation-summary="ModelOnly" class="text-danger"></div>
                <div class="form-group">
                    <input type="submit" value="Save" class="btn-primary btn-sm" />
                </div>
            </form>
        </div>
    </div>
</div>

<div>
    <a asp-action="Index">Back to group</a>
</div>

@section Scripts {
    <script type="text/javascript">
        var counter = 0;
        var template = $('#template').html();

        $(document).ready(function () {

            var rendered = "";
            var emailAddresses = $('#EmailAddresses').val();
            if (emailAddresses !== '') {
                var members = emailAddresses.split(',');

                Mustache.parse(template);
                members.forEach(function (index) {
                    counter++;
                    rendered += Mustache.render(template, { email: index, id: counter });
                });

                $('#Members').html(rendered);
            } else {
                $('#Members').html($('#nomembersTemplate').html());
            }
        });

        function deleteMember(id) {
            var item = $('#member-' + id);
            var email = item.data("email");
            item.remove();
            var emails = $('#EmailAddresses').val().replace(email, "");
            $('#EmailAddresses').val(emails);
        }

        function addMember() {
            var emailBox = $('#AddEmail');
            var membersList = $('#Members');
            var emailAddressesHidden = $('#EmailAddresses');
            email = emailBox.val();

            if (validateEmail(email) && emailAddressesHidden.val().indexOf(email) == -1) {
                $('#AddEmailValidator').hide()
                $('#noMembersWarning').hide()
                emailBox.val('');

                counter++;

                var element = Mustache.render(template, { email: email, id: counter });
                membersList.append(element);
                var emails = emailAddressesHidden.val() + ',' + email;
                emailAddressesHidden.val(emails)
            } else {
                $('#AddEmailValidator').show()
            }

            emailBox.focus();           
        }

        function validateEmail($email) {
            var emailReg = /^([a-zA-Z0-9_.+-])+\@@(([a-zA-Z0-9-])+\.)+([a-zA-Z0-9]{2,4})+$/;
            return emailReg.test($email);
        }
    </script>
}

<script id="template" type="x-tmpl-mustache">
    <div id="member-{{id}}" class="btn-info" style="padding:5px; margin:2px;" data-email="{{email}}">
        {{email}} <i id="member-{{id}}-delete" class="fa fa-trash" style="float:right; padding:3px 0 0 10px;" aria-hidden="true" onclick="deleteMember({{id}})"></i>
    </div>
</script>

<script id="nomembersTemplate" type="x-tmpl-mustache">
    <div id="noMembersWarning" class="bg-warning warning">No one else is in your group yet!</div>
</script>